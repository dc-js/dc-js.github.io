---
layout: example
title: Filtering Example
additional_head: |
  <style>
    .col {
      min-width: 300px;
      max-width: 360px;
    }
    #download-type {
      margin: 10px 0;
    }
    #download-type div label {
      margin-right: 20px;
    }
  </style>
---

<div class="row justify-content-center">
  <div class="col">
    <h4 class="chart-title">Year</h4>
    <div id="chart-ring-year" class="ratio ratio-1x1 chart-with-reset">
      <div class="reset" style="visibility: hidden">
        selected: <span class="filter"></span>
        <a href="javascript:yearRingChart.filterAll();chartGroup.redrawAll();"
          >reset</a
        >
      </div>
    </div>
  </div>
  <div class="col">
    <h4 class="chart-title">Spend</h4>
    <div id="chart-hist-spend" class="ratio ratio-1x1 chart-with-reset">
      <div class="reset" style="visibility: hidden">
        range: <span class="filter"></span>
        <a href="javascript:spendHistChart.filterAll();chartGroup.redrawAll();"
          >reset</a
        >
      </div>
    </div>
  </div>
  <div class="col">
    <h4 class="chart-title">Spender</h4>
    <div id="chart-row-spenders" class="ratio ratio-1x1 chart-with-reset">
      <div class="reset" style="visibility: hidden">
        selected: <span class="filter"></span>
        <a href="javascript:spenderRowChart.filterAll();chartGroup.redrawAll();"
          >reset</a
        >
      </div>
    </div>
  </div>
  <!-- not sure why all these styles necessary, not the point of this -->
  <div class="col">
    <h4 class="chart-title">Download</h4>
    <div id="table"></div>
    <div id="download-type">
      <div>
        <input
          class="form-check-input"
          type="radio"
          name="operation"
          id="radio-all-data"
          value="raw"
          checked="checked"
        />
        <label class="form-check-label" for="radio-all-data"> all data </label>
        <input
          class="form-check-input"
          type="radio"
          name="operation"
          id="radio-table-data"
          value="table"
        />
        <label class="form-check-label" for="radio-table-data">
          table data
        </label>
      </div>
    </div>
    <div>
      <button class="btn btn-primary" id="download">download</button>
    </div>
  </div>
</div>

<script
  src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"
  integrity="sha256-xoh0y6ov0WULfXcLMoaA6nZfszdgI8w2CEJ/3k8NBIE="
  crossorigin="anonymous"
></script>

<script type="text/javascript">
  const chartGroup = new dc.ChartGroup();
  /* global saveAs */

  const yearRingChart = new dc.PieChart('#chart-ring-year', chartGroup),
    spendHistChart = new dc.BarChart('#chart-hist-spend', chartGroup),
    spenderRowChart = new dc.RowChart('#chart-row-spenders', chartGroup);

  const table = new dc.DataTable('#table', chartGroup);

  // use static or load via d3.csv("spendData.csv").then(function(spendData) {/* do stuff */});
  const spendData = [
    { Name: 'Mr A', Spent: '$40', Year: 2011 },
    { Name: 'Mr B', Spent: '$10', Year: 2011 },
    { Name: 'Mr C', Spent: '$40', Year: 2011 },
    { Name: 'Mr A', Spent: '$70', Year: 2012 },
    { Name: 'Mr B', Spent: '$20', Year: 2012 },
    { Name: 'Mr B', Spent: '$50', Year: 2013 },
    { Name: 'Mr C', Spent: '$30', Year: 2013 },
  ];

  // normalize/parse data
  spendData.forEach(d => {
    d.Spent = d.Spent.match(/\d+/)[0];
  });

  // set crossfilter
  const ndx = crossfilter(spendData),
    yearDim = ndx.dimension(d => +d.Year),
    spendDim = ndx.dimension(d => Math.floor(d.Spent / 10)),
    nameDim = ndx.dimension(d => d.Name),
    spendPerYear = yearDim.group().reduceSum(d => +d.Spent),
    spendPerName = nameDim.group().reduceSum(d => +d.Spent),
    spendHist = spendDim.group().reduceCount();

  yearRingChart
    .dataProvider(
      new dc.CFSimpleAdapter({
        dimension: yearDim,
        group: spendPerYear,
      })
    )
    .configure({
      innerRadius: 50,
      controlsUseVisibility: true,
    });

  spendHistChart
    .dataProvider(
      new dc.CFMultiAdapter({
        dimension: spendDim,

        layers: [
          {
            group: spendHist,
          },
        ],
      })
    )
    .configure({
      elasticY: true,
      controlsUseVisibility: true,
    })
    .x(d3.scaleLinear().domain([0, 10]));

  spendHistChart.xAxis().tickFormat(d => d * 10); // convert back to base unit
  spendHistChart.yAxis().ticks(2);

  spenderRowChart
    .dataProvider(
      new dc.CFSimpleAdapter({
        dimension: nameDim,
        group: spendPerName,
      })
    )
    .configure({
      elasticX: true,
      controlsUseVisibility: true,
    });

  const allDollars = ndx.groupAll().reduceSum(d => +d.Spent);

  table
    .dataProvider(
      new dc.CFSimpleAdapter({
        dimension: spendDim,
      })
    )
    .configure({
      sortBy: d => +d.Spent,
      showSections: false,

      columns: [
        'Name',
        {
          label: 'Spent',
          format: function (d) {
            return `$${d.Spent}`;
          },
        },
        'Year',
        {
          label: 'Percent of Total',
          format: function (d) {
            return `${Math.floor((d.Spent / allDollars.value()) * 100)}%`;
          },
        },
      ],
    });

  d3.select('#download').on('click', () => {
    let rawData;

    if (d3.select('#download-type input:checked').node().value === 'table') {
      // collect the data displayed in the table as an array of arrays
      const data = Array.from(
        document.querySelector('#table').querySelectorAll('tr')
      ).map(row =>
        Array.from(row.querySelectorAll('th, td')).map(c => c.innerText)
      );

      // convert to a raw string
      rawData = d3.csvFormatRows(data);
    } else {
      // collect the data from Crossfilter
      const data = nameDim.top(Infinity);

      // convert to raw string
      rawData = d3.csvFormat(data);
    }

    const blob = new Blob([rawData], {
      type: 'text/csv;charset=utf-8',
    });

    // use HTML5 save support viahttps://github.com/eligrey/FileSaver.js
    saveAs(blob, 'data.csv');
  });

  chartGroup.renderAll();
</script>
